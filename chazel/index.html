<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Chazel</title>
	<script src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
	<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Poiret+One">
	<link rel="stylesheet" href="http://fonts.googleapis.com/earlyaccess/cwtexhei.css">
	<link rel="stylesheet" href="http://fonts.googleapis.com/earlyaccess/cwtexming.css">
	<link rel="stylesheet" href="./css/reset.css">
	<link rel="stylesheet" href="./css/style.css">
</head>

<body id="top">

<div id="go-back">
	<button onclick="goBack()">回前頁</button>
</div>

<div id="outer-wrapper">
	<header>
		<div><!-- for flex layout -->
			<h1><a href="#top">Chazel</a></h1>
			<span>「我是塞車之神，你也是塞車之神，這座島上的所有人，都是塞車之神。」</span>
		</div>
	</header>
	<!-- end header -->

	<nav id="nav">
		<ul>
			<li><a href="#novel">長篇小說 - 泣城</a></li>
			<li><a href="#short-story">短篇小說</a></li>
			<li><a href="#flash-fiction">極短篇小說</a></li>
			<li><a href="#footer">關於我們</a></li>
		</ul>
	</nav>
	<!-- end nav -->

	<nav id="nav-fixed">
		<span><a href="#top">Chazel</a></span>
		<ul>
			<li><a href="#novel">長篇小說 - 泣城</a></li>
			<li><a href="#short-story">短篇小說</a></li>
			<li><a href="#flash-fiction">極短篇小說</a></li>
			<li><a href="#footer">關於我們</a></li>
		</ul>
	</nav>
	<!-- end nav-fixed -->

	<div id="main-wrapper">
		<div id="summary-wrapper">
			<section>
				<h2>長篇小說 - 泣城</h2>
				<button id="tab-chapter-2" onclick="activeTab(2)" class="btn btn-active">掠食之章</button>
				<button id="tab-chapter-1" onclick="activeTab(1)" class="btn">豢養之章（完結）</button>

				<div id="latest-novel-wrapper">
					<div class="latest-novel-col latest-novel-col-1">
						<div id="latest-novel-cover" class="cover"></div>
					</div>
					<div class="latest-novel-col latest-novel-col-2">
						<span>最新一回</span>
						<h3 id="latest-novel-title">讀取中...</h3>
						<p id="latest-novel-content">讀取中...</p>
					</div>
					<div id="select-chapter">
						<button class="btn" onclick="novelSection.show()">顯示其他章節</button>
					</div>
				</div>
				<!-- end latest-novel-wrapper -->

				<div id="novel-wrapper">
					<div class="grid">
						<div id="novel-1-cover" class="cover"></div>
						<span id="novel-1-category" class="category">讀取中...</span>
						<h3 id="novel-1-title">讀取中...</h3>
						<p id="novel-1-content">讀取中...</p>
					</div>
					<div class="grid">
						<div id="novel-2-cover" class="cover"></div>
						<span id="novel-2-category" class="category">讀取中...</span>
						<h3 id="novel-2-title">讀取中...</h3>
						<p id="novel-2-content">讀取中...</p>
					</div>
					<div class="grid grid-last">
						<div id="novel-3-cover" class="cover"></div>
						<span id="novel-3-category" class="category">讀取中...</span>
						<h3 id="novel-3-title">讀取中...</h3>
						<p id="novel-3-content">讀取中...</p>
					</div>
					<div class="clear"></div>
					<div id="novel-paging" class="paging"></div>
				</div>
				<!-- end novel-wrapper -->
			</section>

			<section id="short-story">
				<h2>短篇小說</h2>
				<div class="grid">
					<div id="short-story-1-cover" class="cover"></div>
					<span id="short-story-1-category" class="category">讀取中...</span>
					<h3 id="short-story-1-title">讀取中...</h3>
					<p id="short-story-1-content">讀取中...</p>
				</div>
				<div class="grid">
					<div id="short-story-2-cover" class="cover"></div>
					<span id="short-story-2-category" class="category">讀取中...</span>
					<h3 id="short-story-2-title">讀取中...</h3>
					<p id="short-story-2-content">讀取中...</p>
				</div>
				<div class="grid grid-last">
					<div id="short-story-3-cover" class="cover"></div>
					<span id="short-story-3-category" class="category">讀取中...</span>
					<h3 id="short-story-3-title">讀取中...</h3>
					<p id="short-story-3-content">讀取中...</p>
				</div>
				<div class="clear"></div>
				<div id="short-story-paging" class="paging"></div>
			</section>
			<!-- end short-story -->
			
			<section id="flash-fiction" class="no-border">
				<h2>極短篇小說</h2>
				<div class="grid">
					<div id="flash-fiction-1-cover" class="cover"></div>
					<span id="flash-fiction-1-category" class="category">讀取中...</span>
					<h3 id="flash-fiction-1-title">讀取中...</h3>
					<p id="flash-fiction-1-content">讀取中...</p>
				</div>
				<div class="grid">
					<div id="flash-fiction-2-cover" class="cover"></div>
					<span id="flash-fiction-2-category" class="category">讀取中...</span>
					<h3 id="flash-fiction-2-title">讀取中...</h3>
					<p id="flash-fiction-2-content">讀取中...</p>
				</div>
				<div class="grid grid-last">
					<div id="flash-fiction-3-cover" class="cover"></div>
					<span id="flash-fiction-3-category" class="category">讀取中...</span>
					<h3 id="flash-fiction-3-title">讀取中...</h3>
					<p id="flash-fiction-3-content">讀取中...</p>
				</div>
				<div class="clear"></div>
				<div id="flash-fiction-paging" class="paging"></div>
			</section>
			<!-- end flash-fiction -->
		</div>
		<!-- end summary-wrapper -->

		<section id="reading-area" class="no-border">
			<h2 id="reading-area-title">讀取中...</h2>
			<div id="reading-area-content" class="reading-col reading-col-1">
				<!--
					content will be inserted here
				-->
				<div id="disqus_thread"></div><!-- should be added first, or it will have some error -->
			</div>
			<div id="sub-col" class="reading-col reading-col-2">
				<div class="sub-row">
					<span>字體大小</span>
					<button id="font-size-btn-1" class="btn reading-setting-btn" onclick="setFontSize(1)">小</button>
					<button id="font-size-btn-2" class="btn btn-active reading-setting-btn" onclick="setFontSize(2)">中</button>
					<button id="font-size-btn-3" class="btn reading-setting-btn" onclick="setFontSize(3)">大</button>
				</div>
				<div class="sub-row">
					<span>行距</span>
					<button id="line-height-btn-1" class="btn reading-setting-btn" onclick="setLineHeight(1)">小</button>
					<button id="line-height-btn-2" class="btn btn-active reading-setting-btn" onclick="setLineHeight(2)">中</button>
					<button id="line-height-btn-3" class="btn reading-setting-btn" onclick="setLineHeight(3)">大</button>
				</div>
				<div class="sub-row">
					<div id="prev" class="btn sub-btn" onclick="prevFunc()">
						<span>上一篇</span>
						<h3 id="prev-article-title">讀取中...</h3>
					</div>
					<div id="next" class="btn sub-btn" onclick="nextFunc()">
						<span>下一篇</span>
						<h3 id="next-article-title">讀取中...</h3>
					</div>
				</div>
			</div>
		</section>
		<!-- end section reading -->
	</div>
	<!-- end main-wrapper -->
</div>
<!-- end outer-wrapper -->

<footer id="footer">
	<div id="footer-wrapper">
		<span>關於我們</span>
		<div class="footer-col">
			<a href="https://www.facebook.com/profile.php?id=100000969435591" target="_blank">
				<img src="./img/footer/chazel.jpg" alt="關於我們 - 陳建佐 Chazel">
			</a>
			<div>
				<span class="name">陳建佐 Chazel</span>
				<span class="description">想要寫關於鯨魚的故事。</span>
			</div>
		</div>
		<div class="footer-col">
			<a href="https://www.facebook.com/ryan.chen.0" target="_blank">
				<img src="./img/footer/ryan.jpg" alt="關於我們 - 陳柏翰 Ryan">
			</a>
			<div>
				<span class="name">陳柏翰 Ryan</span>
				<span class="description">陪襯的小小綠葉。</span>
			</div>
		</div>
		<div class="clear"></div>
	</div>
</footer>

<script>
/**
 * global variables and some settings
 * variables should be changed while adding/deleting articels
 */
var articleNum = {
	novel: [21, 10],
	shortStory: 2,
	flashFiction: 4
};
var pageNum = {
	novel: [],
	shortStory: Math.ceil(articleNum.shortStory / 3),
	flashFiction: Math.ceil(articleNum.flashFiction / 3)
}
var novelChapterNum = articleNum.novel.length;

for(var i = 0; i < novelChapterNum; i++)
	pageNum.novel[i] = Math.ceil(articleNum.novel[i] / 3);

$.ajaxSetup({cache: false }); //not sure whether it will work


/**
 * go back function
 */
function goBack() {
	$("#go-back").hide();
	$("#reading-wrapper").hide();
	$("html,body").scrollTop();
	$("#summary-wrapper").show();
}


/**
 * nav display
 */
var nav = document.getElementById("nav");
var navFixed = document.getElementById("nav-fixed");

function handleNav() {
	if(nav.getBoundingClientRect().top < -50) {
		navFixed.style.transition = "top 0s, opacity 0.5s";
		navFixed.style.top = "0";
		navFixed.style.opacity = 1;
	}
	else {
		navFixed.style.transition = "top 0s 0.5s, opacity 0.5s"; //top delay 0.5s
		navFixed.style.top = "-9999px";
		navFixed.style.opacity = 0;
	}
}

window.addEventListener("scroll", function(){handleNav(); }, false);


/**
 * smooth scrolling
 */
$(document).ready(function() {
	$('a[href*="#"]:not([href="#"])').click(function() {
		$("#reading-wrapper").hide();
		$("#summary-wrapper").show();

		if(location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
			var target = $(this.hash);
			target = target.length? target : $('[name=' + this.hash.slice(1) +']');
			if(target.length) {
				$("html,body").animate({scrollTop: target.offset().top - 80}, 800);
				$("#go-back").hide();
        		return false;
        	}
        }
    });
});


/**
 * active tab
 */
var activeChapter = novelChapterNum;

function activeTab(targetChapter) {
	//tab
	for(var i = 1; i <= novelChapterNum; i++) {
		var tab = document.getElementById("tab-chapter-" + i);
		tab.className = tab.className.replace(/ btn-active/g, "");
	}
	document.getElementById("tab-chapter-" + targetChapter).className += " btn-active";

	//content
	loadLatestChapterArticle(targetChapter);
	deployPagingBtn("novel", targetChapter);
	loadSummary("novel", targetChapter, 1); //load the summary of latest article

	activeChapter = targetChapter;
}

function loadLatestChapterArticle(targetChapter) {
	$("#latest-novel-title").html("讀取中...");
	$("#latest-novel-content").html("讀取中...");

	var src = "http://eightdonuts.github.io/chazel/text/novel/chapter-" + targetChapter + "/" + articleNum.novel[targetChapter - 1];
	$.get(src, function(data) {
		var a = data.split("\n"); //article array

		//load cover
		$("#latest-novel-cover").css({
			background: "url('./img/cover/novel/" + a[0] + "') center center",
			backgroundSize: "cover"
		})
		.unbind().click(function() {
			readArticle("novel", targetChapter, articleNum.novel[targetChapter - 1]);
		});

		//load article
		$("#latest-novel-title").html(a[1])
		.unbind().click(function() {
			readArticle("novel", targetChapter, articleNum.novel[targetChapter - 1]);
		});
		$("#latest-novel-content").html(a[2].replace(/<br>/g, "").replace(/　/g, "").substring(0, 120) + "...");
	});
}


/**
 * select other chapter in latest novel section
 */
var novelSection = {
	show: function() {
		$("#latest-novel-wrapper").hide();
		$("#novel-wrapper").show();
	},
	hide: function() {
		$("#novel-wrapper").hide();
		$("#latest-novel-wrapper").show();
	}
}


/**
 * AJAX
 */
function loadSummary(section, subSection, targetPage) {
	var articleN, pageN;
	switch(section) {
		case "novel":
			articleN = articleNum.novel[subSection - 1];
			break;
		case "short-story":
			articleN = articleNum.shortStory;
			break;
		case "flash-fiction":
			articleN = articleNum.flashFiction;
			break;
	}
	pageN = Math.ceil(articleN / 3);

	//button style
	for(var p = 1; p <= pageN; p++)
		$("#" + section + "-paging-btn-" + p).removeClass("btn-active");
	$("#" + section + "-paging-btn-" + targetPage).addClass("btn-active");

	//deploy article summary
	for(var col = 1; col <= 3; col++) {
		var articleID = articleN - 3 * (targetPage - 1) - col + 1;
		if(articleID <= 0) {
			for(var i = col; i <= 3; i++) {
				deployArticleSummary(section, subSection, i, 0); //deploy an empty page
			}
			break;
		}
		$("#" + section + "-" + col + "-title").html("讀取中...");
		$("#" + section + "-" + col + "-content").html("讀取中...");
		deployArticleSummary(section, subSection, col, articleID);
	}
}

function deployArticleSummary(section, subSection, col, articleID) {
	//deploy an empty page
	if(articleID == 0) {
		$("#" + section + "-" + col + "-cover").css("background-image", "none");
		$("#" + section + "-" + col + "-category").html("");
		$("#" + section + "-" + col + "-title").html("");
		$("#" + section + "-" + col + "-content").html("");
		return;
	}

	var srcHeader;
	if(section == "novel")
		srcHeader = "http://eightdonuts.github.io/chazel/text/novel/chapter-" + subSection + "/";
	else
		srcHeader = "http://eightdonuts.github.io/chazel/text/" + section + "/";

	$.get(srcHeader + articleID, function(data) {
		var a = data.split("\n"); //article array

		//load cover
		$("#" + section + "-" + col + "-cover")
		.css({
			background: "url('./img/cover/" + section + "/" + a[0] + "') center center",
			backgroundSize: "cover"
		})
		.unbind().click(function() {
			readArticle(section, subSection, articleID);
		});

		//load article
		switch(section) {
			case "novel":
				$("#" + section + "-" + col + "-category").html("長篇小說");
				break;
			case "short-story":
				$("#" + section + "-" + col + "-category").html("短篇小說");
				break;
			case "flash-fiction":
				$("#" + section + "-" + col + "-category").html("極短篇小說");
				break;
		}
		$("#" + section + "-" + col + "-title").html(a[1])
		.unbind().click(function() {
			readArticle(section, null, articleID);
		});
		$("#" + section + "-" + col + "-content").html(a[2].replace(/<br>/g, "").replace(/　/g, "").substring(0, 120) + "...");
	});
}

/**
 * deploy paging buttons
 * doesn't set the style of active button (e.g. the first page)
 */
function deployPagingBtn(section, subSection) {
	var pageN, output = [];

	switch(section) {
		case "novel":
			pageN = pageNum.novel[subSection - 1];
			break;
		case "short-story":
			pageN = pageNum.shortStory;
			break;
		case "flash-fiction":
			pageN = pageNum.flashFiction;
			break;
	}

	for(var page = 1; page <= pageN; page++)
		output.push("<button id=\"" + section + "-paging-btn-" + page + "\" class=\"btn\" onclick=\"loadSummary('" + section + "', " + subSection + ", " + page + ")\">" + page + "</button>");
	if(section == "novel")
		output.push("<button class=\"btn\" onclick=\"novelSection.hide()\">顯示最新一回</button>")
	$("#" + section + "-paging").html(output.join(""));
}


/**
 * read the target article
 */
var prevFunc, nextFunc;
function readArticle(section, subSection, articleID) {
	$("#summary-wrapper").hide();
	$("html,body").scrollTop();
	$("#go-back").show();
	$("#reading-area").show();

	var articleN;
	switch(section) {
		case "novel":
			articleN = articleNum.novel[subSection - 1];
			break;
		case "short-story":
			articleN = articleNum.shortStory;
			break;
		case "flash-fiction":
			articleN = articleNum.flashFiction;
			break;
	}

	//initialize reading area
	$("#reading-area-title").html("讀取中...");
	$("#reading-area-content").html("<div id=\"disqus_thread\"></div>");
	resetDisqus(section, subSection, articleID);

	//load the target article
	var srcHeader;
	if(section == "novel")
		srcHeader = "http://eightdonuts.github.io/chazel/text/novel/chapter-" + subSection + "/";
	else
		srcHeader = "http://eightdonuts.github.io/chazel/text/" + section + "/";

	$.get(srcHeader + articleID, function(data) {
		var a = data.split("\n");
		$("#reading-area-title").html(a[1]);
		$("<div>" + a[2] + "</div>").insertBefore("#disqus_thread");
	});

	//deploy sub-column
	$("#prev-article-title").html("讀取中...");
	$("#next-article-title").html("讀取中...");

	if(articleID > 1) {
		$.get(srcHeader + (articleID - 1), function(data) {
			$("#prev-article-title").html(data.split("\n")[1]);
			prevFunc = function() {
				readArticle(section, subSection, articleID - 1);
			}
		});
		$("#prev").show();
	}
	else $("#prev").hide();

	if(articleID < articleNum) {
		$.get(src + (articleID + 1), function(data) {
			$("#next-article-title").html(data.split("\n")[1]);
			nextFunc = function() {
				readArticle(section, subSection, articleID + 1);
			}
		});
		$("#next").show()
	}
	else $("#next").hide();
}


/**
 * change font-size
 */
 var readingSetting = {
 	fontSize: [14, 16, 20],
 	lineHeight: [1.6, 2.0, 2.4]
 }

function setFontSize(level) {
	//button style
	for(var i = 1; i <= 3; i++) {
		var tab = document.getElementById("font-size-btn-" + i);
		tab.className = tab.className.replace(/ btn-active/g, "");
	}
	document.getElementById("font-size-btn-" + level).className += " btn-active";

	$("#reading-area-content").css("font-size",  readingSetting.fontSize[level - 1] + "px");
}

function setLineHeight(level) {
	//button style
	for(var i = 1; i <= 3; i++) {
		var tab = document.getElementById("line-height-btn-" + i);
		tab.className = tab.className.replace(/ btn-active/g, "");
	}
	document.getElementById("line-height-btn-" + level).className += " btn-active";

	$("#reading-area-content").css("line-height",  readingSetting.lineHeight[level - 1]);
}



/**
 * disqus
 */
 var disqus_config = function () {
	this.page.url = "http://eightdonuts.github.io/chazel/";
	this.page.identifier = "home";
};

(function() {
	var d = document, s = d.createElement('script');
	s.src = 'http://chazeldisqus.disqus.com/embed.js';
	s.setAttribute('data-timestamp', +new Date());
	(d.head || d.body).appendChild(s);
})();//don't edit this

function resetDisqus(section, subSection, articleID) {
	var identifier;
	if(subSection == null)
    	identifier = section + "__" + articleID;
    else
    	identifier = section + "__" + subSection + "__" + articleID;

	DISQUS.reset({
	  reload: true,
	  config: function () {  
	    this.page.url = "http://eightdonuts.github.io/chazel/#!" + identifier;
    	this.page.identifier = identifier;
	  }
	});
}


/**
 * deploy initial page
 */
loadLatestChapterArticle(novelChapterNum);
deployPagingBtn("short-story", null);
loadSummary("short-story", null, 1);
deployPagingBtn("flash-fiction", null);
loadSummary("flash-fiction", null, 1);
</script>
</body>
</html>